<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI Smart Call Center Dashboard - Analytics and Insights">
    <title>Dashboard | Vadodara Nagar Samwad</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/landing.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Particles Container for Animation -->
    <div id="particles" class="particles-container"></div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <a href="index.html" class="nav-brand">
            <span class="emblem">üèõÔ∏è</span>
            <div class="nav-brand-text">
                <span class="title">Vadodara Nagar Samwad</span>
                <span class="subtitle">‡§µ‡§°‡•ã‡§¶‡§∞‡§æ ‡§®‡§ó‡§∞ ‡§∏‡§Ç‡§µ‡§æ‡§¶ | ‡™µ‡™°‡´ã‡™¶‡™∞‡™æ ‡™®‡™ó‡™∞ ‡™∏‡™Ç‡™µ‡™æ‡™¶</span>
            </div>
        </a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
            <a href="complaint.html" class="nav-link">Register Complaint</a>
            <a href="call.html" class="nav-link">Voice Call</a>
            <a href="dashboard.html" class="nav-link active">Dashboard</a>
            <a href="call.html" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                Start AI Call
            </a>
        </div>
    </nav>

    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>üìä Analytics Dashboard</h1>
            <p>Real-time insights and complaint tracking powered by AI automation</p>
            <div class="connection-status" id="connectionStatus">
                <span class="status-dot online"></span>
                <span>Live Data</span>
            </div>
        </header>

        <main class="dashboard-main">
            <!-- Main Content Wrapper with Sidebar -->
            <div style="display: grid; grid-template-columns: 1fr 350px; gap: var(--space-xl);">
                <!-- Left Content Area -->
                <div>
                    <!-- Navigation -->
                    <div class="dashboard-nav glass-card"
                        style="display: flex; justify-content: center; gap: var(--space-md); margin-bottom: var(--space-xl); padding: var(--space-md);">
                        <a href="index.html" class="btn btn-secondary" style="padding: 0.75rem 1.25rem;"> Home</a>
                        <a href="call.html" class="btn btn-primary" style="padding: 0.75rem 1.25rem;"> New Complaint</a>
                        <button id="refreshBtn" class="btn btn-secondary" style="padding: 0.75rem 1.25rem;">üîÑ
                            Refresh</button>
                    </div>

                    <!-- Stats Grid -->
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üìù</div>
                            <div class="stat-value" id="totalComplaints">--</div>
                            <div class="stat-label">Total Complaints</div>
                            <div class="stat-trend up" id="totalTrend">
                                <span>‚Üë --</span> vs last week
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚úÖ</div>
                            <div class="stat-value" id="resolvedComplaints">--</div>
                            <div class="stat-label">Resolved</div>
                            <div class="stat-trend up" id="resolvedTrend">
                                <span>‚Üë --</span> vs last week
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚è≥</div>
                            <div class="stat-value" id="pendingComplaints">--</div>
                            <div class="stat-label">In Progress</div>
                            <div class="stat-trend down" id="pendingTrend">
                                <span>‚Üì --</span> vs last week
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚ö°</div>
                            <div class="stat-value" id="avgResolution">--</div>
                            <div class="stat-label">Avg. Resolution (Days)</div>
                            <div class="stat-trend up" id="resolutionTrend">
                                <span>‚Üë --</span> faster
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--space-xl); margin-bottom: var(--space-xl);">
                        <!-- Bar Chart -->
                        <div class="chart-container glass-card">
                            <h3 class="chart-title">üìä Complaints by Category</h3>
                            <div class="chart-wrapper">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>

                        <!-- Doughnut Chart -->
                        <div class="chart-container glass-card">
                            <h3 class="chart-title">üìà Status Distribution</h3>
                            <div class="chart-wrapper">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Line Chart - Full Width -->
                    <div class="chart-container glass-card" style="margin-bottom: var(--space-xl);">
                        <h3 class="chart-title">üìâ Weekly Trend</h3>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <!-- Recent Complaints Table -->
                    <div class="glass-card" style="padding: var(--space-xl);">
                        <h3 class="chart-title" style="margin-bottom: var(--space-lg);">üïê Recent Complaints</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Area</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="recentComplaints">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: var(--text-muted);">Loading
                                            complaints...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - ID Tracker -->
                <div style="position: sticky; top: var(--space-lg); height: fit-content;">
                    <!-- ID Tracker Card -->
                    <div class="glass-card" style="margin-bottom: var(--space-lg);">
                        <h3
                            style="margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
                            <span style="font-size: 1.5rem;">üîç</span> Track Complaint
                        </h3>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: var(--space-md);">
                            Enter your complaint ID to check status
                        </p>

                        <div style="margin-bottom: var(--space-md);">
                            <input type="text" id="trackingId" placeholder="Enter Complaint ID (e.g., VMC-SL-...)"
                                style="width: 100%; padding: var(--space-sm); border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 0.95rem;">
                        </div>

                        <button id="trackButton" class="btn btn-primary"
                            style="width: 100%; margin-bottom: var(--space-md);">
                            üîç Track Now
                        </button>

                        <!-- Results Area -->
                        <div id="trackingResults" style="display: none;">
                            <div
                                style="border-top: 2px solid var(--border-color); padding-top: var(--space-md); margin-top: var(--space-md);">
                                <div style="margin-bottom: var(--space-sm);">
                                    <strong style="color: var(--text-secondary);">Complaint ID:</strong>
                                    <div id="resultId"
                                        style="font-family: monospace; color: var(--primary); margin-top: 0.25rem;">
                                    </div>
                                </div>
                                <div style="margin-bottom: var(--space-sm);">
                                    <strong style="color: var(--text-secondary);">Category:</strong>
                                    <div id="resultCategory" style="margin-top: 0.25rem;"></div>
                                </div>
                                <div style="margin-bottom: var(--space-sm);">
                                    <strong style="color: var(--text-secondary);">Area:</strong>
                                    <div id="resultArea" style="margin-top: 0.25rem;"></div>
                                </div>
                                <div style="margin-bottom: var(--space-sm);">
                                    <strong style="color: var(--text-secondary);">Status:</strong>
                                    <div id="resultStatus" style="margin-top: 0.25rem;"></div>
                                </div>
                                <div style="margin-bottom: var(--space-sm);">
                                    <strong style="color: var(--text-secondary);">Submitted:</strong>
                                    <div id="resultTime" style="margin-top: 0.25rem;"></div>
                                </div>
                                <div>
                                    <strong style="color: var(--text-secondary);">Description:</strong>
                                    <div id="resultDescription"
                                        style="margin-top: 0.25rem; color: var(--text-muted); font-size: 0.9rem;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Error Message -->
                        <div id="trackingError"
                            style="display: none; padding: var(--space-sm); background: var(--danger-light); border-radius: var(--radius-md); color: var(--danger); font-size: 0.9rem;">
                        </div>
                    </div>

                    <!-- Quick Stats Sidebar -->
                    <div class="glass-card">
                        <h4 style="margin-bottom: var(--space-md); font-size: 1rem;">üìà Quick Stats</h4>
                        <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                            <div
                                style="display: flex; justify-content: space-between; padding: var(--space-xs); border-bottom: 1px solid var(--border-light);">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">Today</span>
                                <strong style="color: var(--primary);" id="todayCount">--</strong>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: var(--space-xs); border-bottom: 1px solid var(--border-light);">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">This Week</span>
                                <strong style="color: var(--primary);" id="weekCount">--</strong>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: var(--space-xs); border-bottom: 1px solid var(--border-light);">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">This Month</span>
                                <strong style="color: var(--primary);" id="monthCount">--</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: var(--space-xs);">
                                <span style="color: var(--text-muted); font-size: 0.85rem;">Resolution Rate</span>
                                <strong style="color: var(--success);" id="resolutionRate">--</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Last Updated -->
                    <div
                        style="text-align: center; margin-top: var(--space-md); color: var(--text-muted); font-size: 0.8rem;">
                        Last updated: <span id="lastUpdated">--</span>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>¬© 2026 Vadodara Nagar Samwad | Municipal Corporation | AI-Powered Citizen Services</p>
        </footer>
    </div>

    <script src="js/config.js"></script>
    <script>
        // ========== DASHBOARD APPLICATION ==========

        // Chart instances (for updating)
        let categoryChartInstance = null;
        let statusChartInstance = null;
        let trendChartInstance = null;

        // Cache for complaints data
        let complaintsCache = [];
        let lastFetchTime = null;

        // Government theme colors
        const CHART_COLORS = {
            govBlue: '#1a4f8b',
            govGreen: '#138808',
            govSaffron: '#f7931e',
            textColor: '#4a5568',
            gridColor: 'rgba(0, 0, 0, 0.05)',
            pending: '#f7931e',
            inProgress: '#1a4f8b',
            resolved: '#138808'
        };

        // Generate floating particles
        function createParticles() {
            const container = document.getElementById('particles');
            if (!container) return;

            const particleCount = 25;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (Math.random() * 20 + 15) + 's';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.width = (Math.random() * 4 + 2) + 'px';
                particle.style.height = particle.style.width;
                container.appendChild(particle);
            }
        }

        // Animate stat numbers
        function animateValue(element, start, end, duration, isDecimal = false) {
            const range = end - start;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                const current = start + (range * easeProgress);

                if (isDecimal) {
                    element.textContent = current.toFixed(1);
                } else {
                    element.textContent = Math.floor(current).toLocaleString();
                }

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // Initialize Charts
        function initCharts() {
            initCategoryChart([]);
            initStatusChart({ resolved: 0, in_progress: 0, pending: 0 });
            initTrendChart([]);
        }

        function initCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            const categoryGradient1 = ctx.createLinearGradient(0, 0, 0, 300);
            categoryGradient1.addColorStop(0, 'rgba(26, 79, 139, 0.9)');
            categoryGradient1.addColorStop(1, 'rgba(26, 79, 139, 0.5)');

            const categoryGradient2 = ctx.createLinearGradient(0, 0, 0, 300);
            categoryGradient2.addColorStop(0, 'rgba(19, 136, 8, 0.9)');
            categoryGradient2.addColorStop(1, 'rgba(19, 136, 8, 0.5)');

            const labels = Object.keys(data.total || {});
            const totalData = Object.values(data.total || {});
            const resolvedData = Object.values(data.resolved || {});

            categoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.length > 0 ? labels : ['Street Light', 'Water Supply', 'Road Damage', 'Garbage', 'Drainage'],
                    datasets: [{
                        label: 'Total',
                        data: totalData.length > 0 ? totalData : [0, 0, 0, 0, 0],
                        backgroundColor: categoryGradient1,
                        borderColor: CHART_COLORS.govBlue,
                        borderWidth: 2,
                        borderRadius: 8
                    }, {
                        label: 'Resolved',
                        data: resolvedData.length > 0 ? resolvedData : [0, 0, 0, 0, 0],
                        backgroundColor: categoryGradient2,
                        borderColor: CHART_COLORS.govGreen,
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: CHART_COLORS.textColor, padding: 20 }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: CHART_COLORS.gridColor },
                            ticks: { color: CHART_COLORS.textColor }
                        },
                        y: {
                            grid: { color: CHART_COLORS.gridColor },
                            ticks: { color: CHART_COLORS.textColor }
                        }
                    }
                }
            });
        }

        function initStatusChart(statusCounts) {
            const ctx = document.getElementById('statusChart').getContext('2d');

            if (statusChartInstance) {
                statusChartInstance.destroy();
            }

            statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Resolved', 'In Progress', 'Pending'],
                    datasets: [{
                        data: [statusCounts.resolved || 0, statusCounts.in_progress || 0, statusCounts.pending || 0],
                        backgroundColor: [
                            CHART_COLORS.govGreen,
                            CHART_COLORS.govBlue,
                            CHART_COLORS.govSaffron
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: CHART_COLORS.textColor, padding: 15 }
                        }
                    }
                }
            });
        }

        function initTrendChart(weeklyData) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChartInstance) {
                trendChartInstance.destroy();
            }

            const trendGradient = ctx.createLinearGradient(0, 0, 0, 350);
            trendGradient.addColorStop(0, 'rgba(26, 79, 139, 0.2)');
            trendGradient.addColorStop(1, 'rgba(26, 79, 139, 0)');

            const labels = weeklyData.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const newComplaints = weeklyData.newComplaints || [0, 0, 0, 0, 0, 0, 0];
            const resolvedComplaints = weeklyData.resolved || [0, 0, 0, 0, 0, 0, 0];

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Complaints',
                        data: newComplaints,
                        fill: true,
                        backgroundColor: trendGradient,
                        borderColor: CHART_COLORS.govBlue,
                        borderWidth: 3,
                        tension: 0.4,
                        pointBackgroundColor: CHART_COLORS.govBlue,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }, {
                        label: 'Resolved',
                        data: resolvedComplaints,
                        fill: false,
                        borderColor: CHART_COLORS.govGreen,
                        borderWidth: 3,
                        tension: 0.4,
                        pointBackgroundColor: CHART_COLORS.govGreen,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: CHART_COLORS.textColor, padding: 20 }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: CHART_COLORS.gridColor },
                            ticks: { color: CHART_COLORS.textColor }
                        },
                        y: {
                            grid: { color: CHART_COLORS.gridColor },
                            ticks: { color: CHART_COLORS.textColor }
                        }
                    }
                }
            });
        }

        // Load real data from API
        async function loadRealData() {
            updateConnectionStatus('loading');

            try {
                const response = await fetch(CONFIG.API.BASE_URL + '/api/complaints');
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();
                const complaints = data.data || [];
                complaintsCache = complaints;
                lastFetchTime = new Date();

                // Process the data
                processAndDisplayData(complaints);

                updateConnectionStatus('online');
                document.getElementById('lastUpdated').textContent = lastFetchTime.toLocaleTimeString();

                console.log('[Dashboard] Loaded', complaints.length, 'complaints from API');

            } catch (error) {
                console.log('[Dashboard] Could not load from API:', error.message);
                updateConnectionStatus('offline');

                // Show zeros if no data
                displayEmptyState();
            }
        }

        function processAndDisplayData(complaints) {
            const total = complaints.length;
            const resolved = complaints.filter(c => c.status === 'resolved').length;
            const inProgress = complaints.filter(c => c.status === 'in_progress').length;
            const pending = complaints.filter(c => c.status === 'pending').length;
            const resolutionRate = total > 0 ? Math.round((resolved / total) * 100) : 0;

            // Calculate time-based stats
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(todayStart);
            weekStart.setDate(weekStart.getDate() - 7);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            const todayCount = complaints.filter(c => new Date(c.created_at) >= todayStart).length;
            const weekCount = complaints.filter(c => new Date(c.created_at) >= weekStart).length;
            const monthCount = complaints.filter(c => new Date(c.created_at) >= monthStart).length;

            // Animate main stats
            animateValue(document.getElementById('totalComplaints'), 0, total, 1000);
            animateValue(document.getElementById('resolvedComplaints'), 0, resolved, 1000);
            animateValue(document.getElementById('pendingComplaints'), 0, pending + inProgress, 1000);
            animateValue(document.getElementById('avgResolution'), 0, total > 0 ? 2.3 : 0, 1000, true);

            // Update Quick Stats sidebar
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('weekCount').textContent = weekCount;
            document.getElementById('monthCount').textContent = monthCount;
            document.getElementById('resolutionRate').textContent = resolutionRate + '%';

            // Update charts with real data
            updateChartsWithRealData(complaints);

            // Update recent complaints table
            updateRecentComplaintsTable(complaints);
        }

        function displayEmptyState() {
            document.getElementById('totalComplaints').textContent = '0';
            document.getElementById('resolvedComplaints').textContent = '0';
            document.getElementById('pendingComplaints').textContent = '0';
            document.getElementById('avgResolution').textContent = '0';
            document.getElementById('todayCount').textContent = '0';
            document.getElementById('weekCount').textContent = '0';
            document.getElementById('monthCount').textContent = '0';
            document.getElementById('resolutionRate').textContent = '0%';
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            const dot = statusEl.querySelector('.status-dot');
            const text = statusEl.querySelector('span:last-child');

            dot.className = 'status-dot';

            switch (status) {
                case 'online':
                    dot.classList.add('online');
                    text.textContent = 'Live Data';
                    break;
                case 'loading':
                    dot.classList.add('loading');
                    text.textContent = 'Loading...';
                    break;
                case 'offline':
                    dot.classList.add('offline');
                    text.textContent = 'Offline';
                    break;
            }
        }

        // Update charts with real complaint data
        function updateChartsWithRealData(complaints) {
            if (complaints.length === 0) return;

            // Count by category
            const categories = {};
            const resolvedByCategory = {};

            complaints.forEach(c => {
                const type = c.complaint_type || 'Other';
                categories[type] = (categories[type] || 0) + 1;
                if (c.status === 'resolved') {
                    resolvedByCategory[type] = (resolvedByCategory[type] || 0) + 1;
                }
            });

            // Update category chart
            initCategoryChart({
                total: categories,
                resolved: resolvedByCategory
            });

            // Count by status
            const statusCounts = {
                resolved: complaints.filter(c => c.status === 'resolved').length,
                in_progress: complaints.filter(c => c.status === 'in_progress').length,
                pending: complaints.filter(c => c.status === 'pending').length
            };

            // Update status chart
            initStatusChart(statusCounts);

            // Calculate weekly trend
            const weeklyData = calculateWeeklyTrend(complaints);
            initTrendChart(weeklyData);
        }

        function calculateWeeklyTrend(complaints) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const now = new Date();
            const labels = [];
            const newComplaints = [];
            const resolved = [];

            // Last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const dayEnd = new Date(dayStart);
                dayEnd.setDate(dayEnd.getDate() + 1);

                labels.push(days[date.getDay()]);

                const dayComplaints = complaints.filter(c => {
                    const created = new Date(c.created_at);
                    return created >= dayStart && created < dayEnd;
                });

                newComplaints.push(dayComplaints.length);
                resolved.push(dayComplaints.filter(c => c.status === 'resolved').length);
            }

            return { labels, newComplaints, resolved };
        }

        // Update recent complaints table with real data
        function updateRecentComplaintsTable(complaints) {
            const tbody = document.getElementById('recentComplaints');
            if (!tbody) return;

            if (complaints.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No complaints registered yet</td></tr>';
                return;
            }

            // Get latest 5 complaints
            const recent = complaints.slice(-5).reverse();

            tbody.innerHTML = recent.map(c => {
                const statusClass = c.status === 'resolved' ? 'resolved' : (c.status === 'in_progress' ? 'processing' : 'pending');
                const statusText = c.status === 'resolved' ? 'Resolved' : (c.status === 'in_progress' ? 'Processing' : 'Pending');
                const type = c.complaint_type || 'Other';
                const typeEmoji = getTypeEmoji(type);
                const timeAgo = getTimeAgo(c.created_at);

                return `
                    <tr>
                        <td><code>${c.id || c.complaint_id || 'N/A'}</code></td>
                        <td><span class="category-badge">${typeEmoji} ${type}</span></td>
                        <td>${c.area || c.ward || 'N/A'}</td>
                        <td><span class="status-tag ${statusClass}">${statusText}</span></td>
                        <td>${timeAgo}</td>
                    </tr>
                `;
            }).join('');
        }

        function getTypeEmoji(type) {
            const emojis = {
                'Street Light': 'üí°',
                'Water Supply': 'üíß',
                'Road Damage': 'üõ£Ô∏è',
                'Garbage': 'üóëÔ∏è',
                'Drainage': 'üöø',
                'Sanitation': 'üßπ',
                'Other': 'üìã'
            };
            return emojis[type] || 'üìã';
        }

        // Calculate time ago
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + ' min ago';
            if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
            return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
        }

        // ID Tracker - Track complaint from API
        async function trackComplaint(complaintId) {
            const trackingResults = document.getElementById('trackingResults');
            const trackingError = document.getElementById('trackingError');

            // Hide previous results
            trackingResults.style.display = 'none';
            trackingError.style.display = 'none';

            if (!complaintId) {
                trackingError.textContent = '‚ö†Ô∏è Please enter a complaint ID';
                trackingError.style.display = 'block';
                return;
            }

            try {
                // First check cache
                let complaint = complaintsCache.find(c =>
                    (c.id && c.id.toUpperCase() === complaintId.toUpperCase()) ||
                    (c.complaint_id && c.complaint_id.toUpperCase() === complaintId.toUpperCase())
                );

                // If not in cache, try API
                if (!complaint) {
                    const response = await fetch(`${CONFIG.API.BASE_URL}/api/complaints/${complaintId}`);
                    if (response.ok) {
                        const data = await response.json();
                        complaint = data.data || data;
                    }
                }

                if (complaint) {
                    displayTrackingResult(complaint);
                } else {
                    trackingError.textContent = '‚ùå Complaint ID not found. Please check and try again.';
                    trackingError.style.display = 'block';
                }
            } catch (error) {
                console.error('Error tracking complaint:', error);
                trackingError.textContent = '‚ùå Error tracking complaint. Please try again.';
                trackingError.style.display = 'block';
            }
        }

        function displayTrackingResult(complaint) {
            const type = complaint.complaint_type || 'Other';
            const typeEmoji = getTypeEmoji(type);

            document.getElementById('resultId').textContent = complaint.id || complaint.complaint_id;
            document.getElementById('resultCategory').innerHTML = `<span class="category-badge">${typeEmoji} ${type}</span>`;
            document.getElementById('resultArea').textContent = complaint.area || complaint.ward || 'N/A';

            let statusHTML = '';
            if (complaint.status === 'pending') {
                statusHTML = '<span class="status-tag pending">Pending</span>';
            } else if (complaint.status === 'in_progress') {
                statusHTML = '<span class="status-tag processing">Processing</span>';
            } else if (complaint.status === 'resolved') {
                statusHTML = '<span class="status-tag resolved">Resolved</span>';
            } else {
                statusHTML = `<span class="status-tag">${complaint.status}</span>`;
            }
            document.getElementById('resultStatus').innerHTML = statusHTML;

            document.getElementById('resultTime').textContent = complaint.created_at ?
                new Date(complaint.created_at).toLocaleString() : 'N/A';
            document.getElementById('resultDescription').textContent = complaint.description || 'No description provided';

            document.getElementById('trackingResults').style.display = 'block';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            createParticles();
            initCharts();
            loadRealData();

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadRealData);

            // Track button
            document.getElementById('trackButton').addEventListener('click', function () {
                const inputId = document.getElementById('trackingId').value.trim();
                trackComplaint(inputId);
            });

            // Allow Enter key to track
            document.getElementById('trackingId').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    trackComplaint(this.value.trim());
                }
            });

            // Auto-refresh every 30 seconds
            setInterval(loadRealData, 30000);
        });
    </script>

    <style>
        /* Particles Container */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            bottom: -20px;
            background: linear-gradient(135deg, rgba(26, 79, 139, 0.3), rgba(19, 136, 8, 0.3));
            border-radius: 50%;
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 0.6;
            }

            90% {
                opacity: 0.6;
            }

            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Connection Status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.online {
            background: #38ef7d;
        }

        .status-dot.loading {
            background: #f7931e;
        }

        .status-dot.offline {
            background: #f5576c;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Dashboard specific styles */
        .stat-trend {
            margin-top: var(--space-sm);
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .stat-trend span {
            font-weight: 600;
        }

        .stat-trend.up span {
            color: #38ef7d;
        }

        .stat-trend.down span {
            color: #f5576c;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .status-badge.online {
            border-color: rgba(56, 239, 125, 0.3);
            color: #38ef7d;
        }

        .status-indicator-dot {
            width: 8px;
            height: 8px;
            background: #38ef7d;
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* Data Table */
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: var(--space-md);
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        .data-table th {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .data-table td {
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .data-table code {
            font-family: 'Space Grotesk', monospace;
            font-size: 0.85rem;
            color: var(--text-accent);
        }

        /* Status Tags */
        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-tag.pending {
            background: rgba(247, 147, 30, 0.2);
            color: #f7931e;
        }

        .status-tag.processing {
            background: rgba(26, 79, 139, 0.2);
            color: #1a4f8b;
        }

        .status-tag.resolved {
            background: rgba(56, 239, 125, 0.2);
            color: #38ef7d;
        }

        /* Category Badge */
        .category-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(26, 79, 139, 0.1);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        /* n8n Features */
        .n8n-feature {
            text-align: center;
            padding: var(--space-lg);
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-lg);
            transition: var(--transition-base);
        }

        .n8n-feature:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-5px);
        }

        .n8n-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-sm);
        }

        .n8n-feature h4 {
            margin-bottom: var(--space-xs);
            color: var(--text-primary);
        }

        .n8n-feature p {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin: 0;
        }

        @media (max-width: 768px) {
            .data-table {
                font-size: 0.85rem;
            }

            .data-table th,
            .data-table td {
                padding: var(--space-sm);
            }

            /* Make layout single column on mobile */
            .dashboard-main>div {
                grid-template-columns: 1fr !important;
            }

            .dashboard-main>div>div:last-child {
                position: static !important;
            }
        }
    </style>
</body>

</html>